# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ JWT –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ BroCar

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         BROCAR APPLICATION                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ   Browser    ‚îÇ      ‚îÇ  Next.js 15  ‚îÇ      ‚îÇ  Supabase    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ   Client     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  Middleware  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ    Auth      ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                      ‚îÇ            ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                      ‚îÇ            ‚îÇ
‚îÇ         ‚îÇ    JWT Cookie        ‚îÇ                      ‚îÇ            ‚îÇ
‚îÇ         ‚îÇ  (httpOnly + secure) ‚îÇ                      ‚îÇ            ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                      ‚îÇ            ‚îÇ
‚îÇ         ‚ñº                      ‚ñº                      ‚ñº            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ   Client     ‚îÇ      ‚îÇ  API Routes  ‚îÇ      ‚îÇ  PostgreSQL  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  Components  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  (withAuth)  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  + RLS       ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User    ‚îÇ
‚îÇ Browser ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. POST /auth/register
     ‚îÇ    { email, password }
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  RegisterPage   ‚îÇ
‚îÇ  (Client)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 2. supabase.auth.signUp()
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase Auth   ‚îÇ
‚îÇ  API             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 3. –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     ‚îÇ    –≤ auth.users
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL      ‚îÇ
‚îÇ  Trigger         ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ handle_new_user()
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç
     ‚îÇ    –∑–∞–ø–∏—Å—å –≤ profiles
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  profiles table  ‚îÇ
‚îÇ  { id, email }   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. POST /auth/login
     ‚îÇ    { email, password }
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LoginPage      ‚îÇ
‚îÇ  (Client)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 2. supabase.auth.signInWithPassword()
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase Auth   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ credentials
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
     ‚îÇ    {
     ‚îÇ      sub: user_id,
     ‚îÇ      email: "user@example.com",
     ‚îÇ      exp: timestamp + 3600
     ‚îÇ    }
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Browser         ‚îÇ
‚îÇ  Cookies:        ‚îÇ
‚îÇ  - sb-access-token  (httpOnly, secure)
‚îÇ  - sb-refresh-token (httpOnly, secure)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3. –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç /dashboard
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Middleware     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç JWT
‚îÇ  (middleware.ts)‚îÇ      –∏–∑ cookies
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 2. supabase.auth.getUser()
     ‚îÇ    (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT)
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase Auth   ‚îÇ
‚îÇ  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç     ‚îÇ
‚îÇ    –ø–æ–¥–ø–∏—Å—å JWT   ‚îÇ
‚îÇ  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç exp ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 3. –ï—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–æ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
     ‚îÇ    –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí redirect /auth/login
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DashboardPage  ‚îÇ
‚îÇ  (Server        ‚îÇ
‚îÇ   Component)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 4. getUser() - –ø–æ–ª—É—á–∞–µ—Ç user –∏–∑ JWT
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Render page     ‚îÇ
‚îÇ  with user data  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4. API –∑–∞–ø—Ä–æ—Å —Å JWT

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. fetch('/api/profile')
     ‚îÇ    (JWT –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ cookies)
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  withAuth()     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ Middleware –¥–ª—è API
‚îÇ  wrapper        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 2. supabase.auth.getUser()
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase Auth   ‚îÇ
‚îÇ  –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç JWT  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 3. –ï—Å–ª–∏ OK ‚Üí –ø–µ—Ä–µ–¥–∞–µ—Ç user –≤ handler
     ‚îÇ    –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí 401 Unauthorized
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  API Handler    ‚îÇ
‚îÇ  (user –¥–æ—Å—Ç—É–ø–µ–Ω)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 4. –ó–∞–ø—Ä–æ—Å –∫ –ë–î
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL      ‚îÇ
‚îÇ  + RLS           ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ –ü–æ–ª—É—á–∞–µ—Ç JWT –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     auth.uid() = user.id
     ‚îÇ
     ‚îÇ 5. RLS —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç:
     ‚îÇ    WHERE user_id = auth.uid()
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–ª—å–∫–æ ‚îÇ
‚îÇ  –¥–∞–Ω–Ω—ã—Ö —é–∑–µ—Ä–∞   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Client Side (`"use client"`)

```
components/
‚îú‚îÄ‚îÄ logout-button.tsx           # –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
‚îî‚îÄ‚îÄ header.tsx                  # Header —Å –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

app/
‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx         # –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ register/page.tsx      # –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ profile/page.tsx           # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è

lib/supabase/
‚îî‚îÄ‚îÄ client.ts                  # Supabase –∫–ª–∏–µ–Ω—Ç –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
import { createClient } from "@/lib/supabase/client";

const supabase = createClient();
await supabase.auth.signInWithPassword({ email, password });
```

### 2. Server Side (Server Components & API)

```
app/
‚îú‚îÄ‚îÄ dashboard/page.tsx         # –ó–∞—â–∏—â–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îî‚îÄ‚îÄ api/
    ‚îú‚îÄ‚îÄ auth/signout/route.ts  # –í—ã—Ö–æ–¥
    ‚îî‚îÄ‚îÄ profile/route.ts       # API –ø—Ä–æ—Ñ–∏–ª—è

lib/
‚îú‚îÄ‚îÄ auth.ts                    # –£—Ç–∏–ª–∏—Ç—ã: getUser(), getSession()
‚îú‚îÄ‚îÄ api-auth.ts                # withAuth(), withOptionalAuth()
‚îî‚îÄ‚îÄ supabase/
    ‚îî‚îÄ‚îÄ server.ts              # Supabase –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞

middleware.ts                  # –ó–∞—â–∏—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
import { getUser } from "@/lib/auth";
import { withAuth } from "@/lib/api-auth";

// Server Component
const user = await getUser();

// API Route
export const GET = withAuth(async (req, { user }) => {
  return NextResponse.json({ user });
});
```

### 3. Database Layer

```
PostgreSQL
‚îú‚îÄ‚îÄ auth.users                 # Supabase Auth (—É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Supabase)
‚îú‚îÄ‚îÄ profiles                   # –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ orders                     # –ó–∞–∫–∞–∑—ã (RLS)
‚îú‚îÄ‚îÄ carts                      # –ö–æ—Ä–∑–∏–Ω—ã (RLS)
‚îî‚îÄ‚îÄ cart_items                 # –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–∞—Ö (RLS)

Triggers:
‚îî‚îÄ‚îÄ handle_new_user()          # –°–æ–∑–¥–∞–µ—Ç profile –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

RLS Policies:
‚îú‚îÄ‚îÄ profiles: view/update own
‚îú‚îÄ‚îÄ orders: view/create/update own
‚îú‚îÄ‚îÄ carts: view/create/update/delete own
‚îî‚îÄ‚îÄ cart_items: view/create/update/delete own
```

---

## JWT Token Structure

### –§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLWlkIiwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIn0.signature
‚îÇ                                      ‚îÇ                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Payload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ Signature
```

### –°–æ–¥–µ—Ä–∂–∏–º–æ–µ JWT

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "aud": "authenticated",
    "exp": 1735344000,
    "iat": 1735340400,
    "sub": "user-uuid-here",
    "email": "user@example.com",
    "phone": "",
    "app_metadata": {
      "provider": "email",
      "providers": ["email"]
    },
    "user_metadata": {
      "full_name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
    },
    "role": "authenticated"
  },
  "signature": "..."
}
```

**–í–∞–∂–Ω—ã–µ –ø–æ–ª—è:**
- `sub` - User ID (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ RLS –∫–∞–∫ `auth.uid()`)
- `exp` - –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ +1 —á–∞—Å)
- `role` - –†–æ–ª—å –¥–ª—è RLS (`authenticated`, `anon`)
- `email` - Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## Row Level Security (RLS)

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SELECT * FROM orders;                                      ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  PostgreSQL –ø–æ–ª—É—á–∞–µ—Ç JWT –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞                       ‚îÇ
‚îÇ  ‚îî‚îÄ‚ñ∫ –ò–∑–≤–ª–µ–∫–∞–µ—Ç user_id –∏–∑ JWT (—á–µ—Ä–µ–∑ auth.uid())          ‚îÇ
‚îÇ      ‚îî‚îÄ‚ñ∫ –ü—Ä–∏–º–µ–Ω—è–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫—É:                           ‚îÇ
‚îÇ          "WHERE user_id = auth.uid()"                      ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–∏—Ç–∏–∫

#### –ü—Ä–æ—Ñ–∏–ª–∏
```sql
-- –ß—Ç–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);
```

#### –ó–∞–∫–∞–∑—ã
```sql
-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤
CREATE POLICY "Users can view own orders"
  ON orders FOR SELECT
  USING (auth.uid() = user_id);

-- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Å–µ–±—è
CREATE POLICY "Users can create own orders"
  ON orders FOR INSERT
  WITH CHECK (auth.uid() = user_id);
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  httpOnly Cookie                                    ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                   ‚îÇ
‚îÇ  - JavaScript –ù–ï –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å                    ‚îÇ
‚îÇ  - –ó–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫                              ‚îÇ
‚îÇ  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  Secure Flag                                        ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                       ‚îÇ
‚îÇ  - –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTPS                              ‚îÇ
‚îÇ  - –ó–∞—â–∏—Ç–∞ –æ—Ç Man-in-the-Middle                     ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  SameSite=Lax                                       ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                      ‚îÇ
‚îÇ  - –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫                             ‚îÇ
‚îÇ  - Cookie –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–∞–π—Ç—ã       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞

```
Layer 1: Middleware
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ –ü–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è –∑–∞—â–∏—Ç—ã
‚îÇ  –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞—Ö        ‚îÇ     Redirect –µ—Å–ª–∏ –Ω–µ—Ç JWT
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Layer 2: API Middleware
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  withAuth()          ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ –í—Ç–æ—Ä–∞—è –ª–∏–Ω–∏—è –∑–∞—â–∏—Ç—ã
‚îÇ  –≤ API routes        ‚îÇ     401 –µ—Å–ª–∏ –Ω–µ—Ç JWT
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Layer 3: Row Level Security
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  RLS –≤ PostgreSQL    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ –¢—Ä–µ—Ç—å—è –ª–∏–Ω–∏—è –∑–∞—â–∏—Ç—ã
‚îÇ  WHERE user_id = X   ‚îÇ     –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Lifecycle JWT —Ç–æ–∫–µ–Ω–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    JWT LIFECYCLE                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –°–æ–∑–¥–∞–Ω–∏–µ (–ø—Ä–∏ –≤—Ö–æ–¥–µ)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email/password
   - Supabase –ø—Ä–æ–≤–µ—Ä—è–µ—Ç credentials
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JWT (—Å—Ä–æ–∫: 1 —á–∞—Å)
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è Refresh Token (—Å—Ä–æ–∫: 30 –¥–Ω–µ–π)
   - –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ httpOnly cookies

2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   - Browser –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie
   - Middleware/API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT
   - –ï—Å–ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π ‚Üí –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
   - –ï—Å–ª–∏ –∏—Å—Ç–µ–∫ ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   - Supabase SDK –ø—Ä–æ–≤–µ—Ä—è–µ—Ç exp
   - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Refresh Token
   - –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π JWT
   - –û–±–Ω–æ–≤–ª—è–µ—Ç cookies

4. –ò—Å—Ç–µ—á–µ–Ω–∏–µ/–í—ã—Ö–æ–¥
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   - JWT –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 1 —á–∞—Å
   - Refresh Token –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π
   - –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ: –æ–±–∞ —Ç–æ–∫–µ–Ω–∞ —É–¥–∞–ª—è—é—Ç—Å—è
   - Redirect –Ω–∞ /auth/login
```

---

## –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
brocar/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/page.tsx           ‚Üê –í—Ö–æ–¥
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register/page.tsx        ‚Üê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/page.tsx           ‚Üê –ó–∞—â–∏—â–µ–Ω–æ JWT
‚îÇ   ‚îú‚îÄ‚îÄ profile/page.tsx             ‚Üê –ó–∞—â–∏—â–µ–Ω–æ JWT
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ auth/signout/route.ts    ‚Üê –í—ã—Ö–æ–¥
‚îÇ       ‚îú‚îÄ‚îÄ profile/route.ts         ‚Üê API –ø—Ä–æ—Ñ–∏–ª—è (JWT)
‚îÇ       ‚îî‚îÄ‚îÄ order/route.ts           ‚Üê API –∑–∞–∫–∞–∑–æ–≤ (JWT + RLS)
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ logout-button.tsx            ‚Üê –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ header.tsx                   ‚Üê Header —Å –º–µ–Ω—é —é–∑–µ—Ä–∞
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                      ‚Üê getUser(), getSession()
‚îÇ   ‚îú‚îÄ‚îÄ api-auth.ts                  ‚Üê withAuth(), withOptionalAuth()
‚îÇ   ‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts                ‚Üê –ö–ª–∏–µ–Ω—Ç –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.ts                ‚Üê –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ db/
‚îÇ       ‚îî‚îÄ‚îÄ schema.ts                ‚Üê Drizzle —Å—Ö–µ–º–∞ + profiles
‚îÇ
‚îú‚îÄ‚îÄ middleware.ts                    ‚Üê –ó–∞—â–∏—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ supabase-schema.sql              ‚Üê –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î
‚îú‚îÄ‚îÄ supabase-auth-schema.sql         ‚Üê –°—Ö–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ + RLS
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ JWT_AUTH_GUIDE.md            ‚Üê –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ QUICK_START.md               ‚Üê –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
    ‚îî‚îÄ‚îÄ ARCHITECTURE.md              ‚Üê –≠—Ç–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### –ö–æ—Ä–∑–∏–Ω–∞ (Cart)

```sql
-- RLS –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
-- 1. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ user_id)
-- 2. –ì–æ—Å—Ç–µ–π (—á–µ—Ä–µ–∑ session_id)

CREATE POLICY "Users can view own cart"
  ON carts FOR SELECT
  USING (
    auth.uid() = user_id OR  -- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π
    session_id IS NOT NULL   -- –ì–æ—Å—Ç—å
  );
```

### –ó–∞–∫–∞–∑—ã (Orders)

```sql
-- –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
CREATE POLICY "Users can view own orders"
  ON orders FOR SELECT
  USING (auth.uid() = user_id);
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ JWT

```typescript
// Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É–µ—Ç JWT
// –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏

// ‚úÖ –ë—ã—Å—Ç—Ä–æ: JWT –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è 1 —Ä–∞–∑
// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
// ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ: –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
```

### RLS Performance

```sql
-- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã:
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_carts_user ON carts(user_id);
CREATE INDEX idx_profiles_email ON profiles(email);

-- PostgreSQL —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç WHERE user_id = X
-- –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–Ω–¥–µ–∫—Å–∞–º
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ JWT

```typescript
// –í middleware.ts
console.log("JWT present:", !!request.cookies.get("sb-access-token"));

// –í API routes
export const GET = withAuth(async (req, { user }) => {
  console.log("User ID:", user.id);
  console.log("Email:", user.email);
  return NextResponse.json({ ok: true });
});
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS

```sql
-- –í Supabase SQL Editor
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω –ª–∏ RLS
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏
SELECT tablename, policyname, cmd, qual
FROM pg_policies 
WHERE schemaname = 'public';
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ BroCar –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - httpOnly cookies + RLS
- ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ + –∏–Ω–¥–µ–∫—Å—ã
- üéØ **–ü—Ä–æ—Å—Ç–æ—Ç—É** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ JWT
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
- üì¶ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - stateless JWT —Ç–æ–∫–µ–Ω—ã

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

